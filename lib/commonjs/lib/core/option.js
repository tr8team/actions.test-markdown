import { KResult } from "./result.js";
import { UnwrapError } from "./error.js";
class Opt {
    // takes in a list of options and returns a new option with a list of some values if all the results are some, and none if any are none
    /**
     * @template T
     * @param i - list of options
     */
    static all(...i) {
        const closure = async () => {
            const some = [];
            let none = 0;
            const r = i.map(async (e) => {
                const isSome = await e.isSome();
                if (isSome) {
                    const ok = await e.unwrap();
                    return ["some", ok];
                }
                else {
                    return ["none", null];
                }
            });
            const a = await Promise.all(r);
            for (const [t, v] of a) {
                if (t === "some") {
                    some.push(v);
                }
                else {
                    none++;
                }
            }
            if (none > 0) {
                return None();
            }
            return Some(some);
        };
        return Opt.fromAsync(closure());
    }
    // Resolve the promise of an option, Promise<Option<T>> to Option<T> without async/await
    /**
     * @template T
     * @param p - promise of an option to resolve
     * @returns {Option<T>} resolved option
     */
    static fromAsync(p) {
        return new KOption((async () => {
            const r = await p;
            const isSome = await r.isSome();
            if (isSome) {
                const ok = await r.unwrap();
                return Promise.resolve(["some", ok]);
            }
            return Promise.resolve(["none", null]);
        })());
    }
    // Create an Option from an async function
    /**
     * @template T
     * @param fn - async function that returns an option
     * @returns {Option<T>} option from the async function
     */
    static async(fn) {
        return Opt.fromAsync(fn());
    }
}
class KOption {
    value;
    constructor(value) {
        this.value = Promise.resolve(value);
    }
    async native() {
        const [, v] = await this.value;
        return v;
    }
    andThen(fn) {
        return new KOption((async () => {
            const [type, value] = await this.value;
            if (type === "none") {
                return [type, value];
            }
            else {
                const mapped = await fn(value);
                const isSome = await mapped.isSome();
                if (isSome) {
                    const v = await mapped.unwrap();
                    return ["some", v];
                }
                else {
                    return ["none", null];
                }
            }
        })());
    }
    asErr(ok) {
        return new KResult((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                const s = await ok;
                return ["ok", s];
            }
            else {
                return ["err", v];
            }
        })());
    }
    asOk(err) {
        return new KResult((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                const s = await err;
                return ["err", s];
            }
            else {
                return ["ok", v];
            }
        })());
    }
    asResult(fn) {
        return new KResult(Promise.resolve(["ok", 0])).andThen(async () => {
            const [t, v] = await this.value;
            return await (async () => {
                if (t === "none") {
                    if (typeof fn.none === "function") {
                        const f = fn.none;
                        return Promise.resolve(f());
                    }
                    else {
                        return Promise.resolve(fn.none);
                    }
                }
                else {
                    return fn.some(v);
                }
            })();
        });
    }
    async isNone() {
        const [t] = await this.value;
        return t === "none";
    }
    async isSome() {
        const [t] = await this.value;
        return t === "some";
    }
    map(fn) {
        return new KOption((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                return [t, v];
            }
            else {
                const fv = await fn(v);
                return [t, fv];
            }
        })());
    }
    async match(fn) {
        const [t, v] = await this.value;
        if (t === "some") {
            return Promise.resolve(fn.some(v));
        }
        else {
            if (typeof fn.none === "function") {
                const f = fn.none;
                return Promise.resolve(f());
            }
            else {
                return Promise.resolve(fn.none);
            }
        }
    }
    run(sideEffect) {
        return new KOption((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                return [t, v];
            }
            else {
                await sideEffect(v);
                return [t, v];
            }
        })());
    }
    async unwrap() {
        const [t, v] = await this.value;
        if (t === "some") {
            return v;
        }
        else {
            throw new UnwrapError("Failed to unwrap", "option", "Expected Some got None");
        }
    }
    async unwrapOr(def) {
        const [t, v] = await this.value;
        if (t === "some") {
            return v;
        }
        else {
            if (typeof def === "function") {
                const f = def;
                return Promise.resolve(f());
            }
            else {
                return def;
            }
        }
    }
}
function Some(v) {
    return new KOption(Promise.resolve(["some", v]));
}
function None() {
    return new KOption(Promise.resolve(["none", null]));
}
export { KOption, Some, None, Opt };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL29wdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFVLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxZQUFZLENBQUM7QUEwQnpDLE1BQU0sR0FBRztJQUNQLHVJQUF1STtJQUN2STs7O09BR0c7SUFDSCxNQUFNLENBQUMsR0FBRyxDQUE4QixHQUFHLENBQVM7UUFDbEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxJQUFvQyxFQUFFO1lBQ3pELE1BQU0sSUFBSSxHQUFrQixFQUFtQixDQUFDO1lBQ2hELElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNiLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMxQixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDaEMsSUFBSSxNQUFNLEVBQUU7b0JBQ1YsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQzVCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3JCO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7aUJBQ3ZCO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0IsS0FBSyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLEtBQUssTUFBTSxFQUFFO29CQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNkO3FCQUFNO29CQUNM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QUFNLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDaEMsSUFBSSxDQUFDLEtBQUssTUFBTSxFQUFFO1lBQ2hCLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7YUFBTTtZQUNMLElBQUksT0FBTyxHQUFHLEtBQUssVUFBVSxFQUFFO2dCQUM3QixNQUFNLENBQUMsR0FBRyxHQUFxQyxDQUFDO2dCQUNoRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUM3QjtpQkFBTTtnQkFDTCxPQUFPLEdBQUcsQ0FBQzthQUNaO1NBQ0Y7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxTQUFTLElBQUksQ0FBSSxDQUFJO0lBQ25CLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkQsQ0FBQztBQUVELFNBQVMsSUFBSTtJQUNYLE9BQU8sSUFBSSxPQUFPLENBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUVELE9BQU8sRUFBVSxPQUFPLEVBQXNCLElBQUksRUFBRSxJQUFJLEVBQWdCLEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgS1Jlc3VsdCwgUmVzdWx0IH0gZnJvbSBcIi4vcmVzdWx0LmpzXCI7XG5pbXBvcnQgeyBVbndyYXBFcnJvciB9IGZyb20gXCIuL2Vycm9yLmpzXCI7XG5cbmludGVyZmFjZSBNYXRjaDxULCBVPiB7XG4gIC8vIE1hcCB0aGUgU29tZSB2YWx1ZSB0byBhIHN0YW5kYXJkIHR5cGVcbiAgc29tZTogKCh2YWw6IFQpID0+IFUpIHwgKCh2YWw6IFQpID0+IFByb21pc2U8VT4pO1xuICAvLyBNYXAgdGhlIE5vbmUgdmFsdWUgdG8gYSBzdGFuZGFyZCB0eXBlXG4gIG5vbmU6ICgoKSA9PiBVKSB8ICgoKSA9PiBQcm9taXNlPFU+KSB8IFUgfCBQcm9taXNlPFU+O1xufVxuXG5pbnRlcmZhY2UgUmVzdWx0TWF0Y2g8VCwgVSwgRT4ge1xuICBzb21lOiAoKHZhbDogVCkgPT4gUmVzdWx0PFUsIEU+KSB8ICgodmFsOiBUKSA9PiBQcm9taXNlPFJlc3VsdDxVLCBFPj4pO1xuICBub25lOlxuICAgIHwgKCgpID0+IFJlc3VsdDxVLCBFPilcbiAgICB8ICgoKSA9PiBQcm9taXNlPFJlc3VsdDxVLCBFPj4pXG4gICAgfCBSZXN1bHQ8VSwgRT5cbiAgICB8IFByb21pc2U8UmVzdWx0PFUsIEU+Pjtcbn1cblxudHlwZSBPcHRpb25Tb21lPFQgZXh0ZW5kcyBPcHRpb248dW5rbm93bj5bXT4gPSB7XG4gIFtLIGluIGtleW9mIFRdOiBLIGV4dGVuZHMgbnVtYmVyXG4gICAgPyBUW0tdIGV4dGVuZHMgT3B0aW9uPGluZmVyIFU+XG4gICAgICA/IFVcbiAgICAgIDogbmV2ZXJcbiAgICA6IG5ldmVyO1xufTtcblxuY2xhc3MgT3B0IHtcbiAgLy8gdGFrZXMgaW4gYSBsaXN0IG9mIG9wdGlvbnMgYW5kIHJldHVybnMgYSBuZXcgb3B0aW9uIHdpdGggYSBsaXN0IG9mIHNvbWUgdmFsdWVzIGlmIGFsbCB0aGUgcmVzdWx0cyBhcmUgc29tZSwgYW5kIG5vbmUgaWYgYW55IGFyZSBub25lXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0gaSAtIGxpc3Qgb2Ygb3B0aW9uc1xuICAgKi9cbiAgc3RhdGljIGFsbDxUIGV4dGVuZHMgT3B0aW9uPHVua25vd24+W10+KC4uLmk6IFsuLi5UXSk6IE9wdGlvbjxPcHRpb25Tb21lPFQ+PiB7XG4gICAgY29uc3QgY2xvc3VyZSA9IGFzeW5jICgpOiBQcm9taXNlPE9wdGlvbjxPcHRpb25Tb21lPFQ+Pj4gPT4ge1xuICAgICAgY29uc3Qgc29tZTogT3B0aW9uU29tZTxUPiA9IFtdIGFzIE9wdGlvblNvbWU8VD47XG4gICAgICBsZXQgbm9uZSA9IDA7XG4gICAgICBjb25zdCByID0gaS5tYXAoYXN5bmMgKGUpID0+IHtcbiAgICAgICAgY29uc3QgaXNTb21lID0gYXdhaXQgZS5pc1NvbWUoKTtcbiAgICAgICAgaWYgKGlzU29tZSkge1xuICAgICAgICAgIGNvbnN0IG9rID0gYXdhaXQgZS51bndyYXAoKTtcbiAgICAgICAgICByZXR1cm4gW1wic29tZVwiLCBva107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFtcIm5vbmVcIiwgbnVsbF07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgYSA9IGF3YWl0IFByb21pc2UuYWxsKHIpO1xuICAgICAgZm9yIChjb25zdCBbdCwgdl0gb2YgYSkge1xuICAgICAgICBpZiAodCA9PT0gXCJzb21lXCIpIHtcbiAgICAgICAgICBzb21lLnB1c2godik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbm9uZSsrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChub25lID4gMCkge1xuICAgICAgICByZXR1cm4gTm9uZTxPcHRpb25Tb21lPFQ+PigpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFNvbWUoc29tZSk7XG4gICAgfTtcbiAgICByZXR1cm4gT3B0LmZyb21Bc3luYyhjbG9zdXJlKCkpO1xuICB9XG5cbiAgLy8gUmVzb2x2ZSB0aGUgcHJvbWlzZSBvZiBhbiBvcHRpb24sIFByb21pc2U8T3B0aW9uPFQ+PiB0byBPcHRpb248VD4gd2l0aG91dCBhc3luYy9hd2FpdFxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHAgLSBwcm9taXNlIG9mIGFuIG9wdGlvbiB0byByZXNvbHZlXG4gICAqIEByZXR1cm5zIHtPcHRpb248VD59IHJlc29sdmVkIG9wdGlvblxuICAgKi9cbiAgc3RhdGljIGZyb21Bc3luYzxUPihwOiBQcm9taXNlPE9wdGlvbjxUPj4pOiBPcHRpb248VD4ge1xuICAgIHJldHVybiBuZXcgS09wdGlvbjxUPihcbiAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHIgPSBhd2FpdCBwO1xuICAgICAgICBjb25zdCBpc1NvbWUgPSBhd2FpdCByLmlzU29tZSgpO1xuICAgICAgICBpZiAoaXNTb21lKSB7XG4gICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCByLnVud3JhcCgpO1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW1wic29tZVwiLCBva10pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW1wibm9uZVwiLCBudWxsXSk7XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBhbiBPcHRpb24gZnJvbSBhbiBhc3luYyBmdW5jdGlvblxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIGZuIC0gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIG9wdGlvblxuICAgKiBAcmV0dXJucyB7T3B0aW9uPFQ+fSBvcHRpb24gZnJvbSB0aGUgYXN5bmMgZnVuY3Rpb25cbiAgICovXG4gIHN0YXRpYyBhc3luYzxUPihmbjogKCkgPT4gUHJvbWlzZTxPcHRpb248VD4+KTogT3B0aW9uPFQ+IHtcbiAgICByZXR1cm4gT3B0LmZyb21Bc3luYyhmbigpKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgT3B0aW9uPFQ+IHtcbiAgLy8gQ2hlY2tzIGlmIHRoZSBPcHRpb24gaXMgU29tZVxuICAvKipcbiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IGlmIHRoZSBvcHRpb24gaXMgU29tZVxuICAgKi9cbiAgaXNTb21lKCk6IFByb21pc2U8Ym9vbGVhbj47XG5cbiAgLy8gQ2hlY2tzIGlmIHRoZSBPcHRpb24gaXMgTm9uZVxuICAvKipcbiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IGlmIHRoZSBvcHRpb24gaXMgTm9uZVxuICAgKi9cbiAgaXNOb25lKCk6IFByb21pc2U8Ym9vbGVhbj47XG5cbiAgLy8gUGF0dGVybiBNYXRjaCBhbmQgcmV0dXJuIGEgc3RhbmRhcmQgdmFsdWUgYnkgcHJvdmlkaW5nIG1hcHBlciBmdW5jdGlvbnMgZm9yXG4gIC8vIFNvbWUgb3IgTm9uZVxuICAvKipcbiAgICogQHRlbXBsYXRlIFQsIFVcbiAgICogQHBhcmFtIGZuIC0gc29tZSBtYXBwZXIgZnVuY3Rpb24gYW5kIG5vbmUgbWFwcGVyIGZ1bmN0aW9uLiBCb3RoIG1hcHBlcnMgY2FuXG4gICAqIGJlIGJvdGggc3luYyBvciBhc3luY1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxVPn0gdGhlIHN0YW5kYXJkIHZhbHVlIHRoYXQgYm90aCBtYXBwZXIgbWFwcyB0b1xuICAgKi9cbiAgbWF0Y2g8VT4oZm46IE1hdGNoPFQsIFU+KTogUHJvbWlzZTxVPjtcblxuICAvLyBNYXBzIHRoZSB1bmRlcmx5aW5nIHZhbHVlIHRvIGFub3RoZXIgdmFsdWUsIGlmIGl0IGlzIG5vdCBOb25lXG4gIC8vIE1hcHBlciBmdW5jdGlvbiBjYW4gYmUgYXN5bmMgb3Igc3luYy5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBULCBVXG4gICAqIEBwYXJhbSBmbiAtIG1hcHBlciBmdW5jdGlvbiB0byBtYXAgdGhlIHVuZGVybHlpbmcgdmFsdWUuIENhbiBiZSBzeW5jIG9yIGFzeW5jXG4gICAqIEByZXR1cm5zIHtPcHRpb248VT59IE1hcHBlZCBPcHRpb25cbiAgICovXG4gIG1hcDxVPihmbjogKCh2YWw6IFQpID0+IFUpIHwgKCh2YWw6IFQpID0+IFByb21pc2U8VT4pKTogT3B0aW9uPFU+O1xuXG4gIC8vIEV4ZWN1dGUgdGhlIG1hcHBlciBmdW5jdGlvbiBpZiBpdCBpcyBub3QgTm9uZSBhbmQgdGhlIG1hcHBlciByZXR1cm5zIGFuIE9wdGlvbi5cbiAgLy8gTWFwcGVyIGZ1bmN0aW9uIGNhbiBiZSBhc3luYyBvciBzeW5jLlxuICAvKipcbiAgICogQHRlbXBsYXRlIFQsVVxuICAgKiBAcGFyYW0gZm4gLSBtYXBwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9uIE9wdGlvbi4gQ2FuIGJlIGFzeW5jIG9yIHN5bmMuXG4gICAqIEByZXR1cm5zIHtPcHRpb248VT59IE1hcHBlZCBPcHRpb25cbiAgICovXG4gIGFuZFRoZW48VT4oXG4gICAgZm46ICgodjogVCkgPT4gT3B0aW9uPFU+KSB8ICgodjogVCkgPT4gUHJvbWlzZTxPcHRpb248VT4+KVxuICApOiBPcHRpb248VT47XG5cbiAgLy8gUmVtb3ZlcyB0aGUgT3B0aW9uIHR5cGUgYW5kIHJldHVybiB0aGUgdW5kZXJseWluZyB2YWx1ZS5cbiAgLy8gVGhyb3dzIGFuIGVycm9yIGlmIE5vbmUgd2FzIGluc2lkZS5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEB0aHJvd3Mge1Vud3JhcEVycm9yfSBJbiB0aGUgZXZlbnQgdGhhdCBpdCB3YXMgYXR0ZW1wdGluZyB0byB1bndyYXAgTm9uZVxuICAgKiBAcmV0dXJuIHtQcm9taXNlPFQ+fSBUaGUgdW5kZXJseWluZyB2YWx1ZVxuICAgKi9cbiAgdW53cmFwKCk6IFByb21pc2U8VD47XG5cbiAgLy8gUmVtb3ZlcyB0aGUgT3B0aW9uIHR5cGUgYW5kIHJldHVybiB0aGUgdW5kZXJseWluZyB2YWx1ZSwgYnV0IGlmIGl0IHJlc29sdmVzIHRvXG4gIC8vIE5vbmUsIGhhbmRsZSBpdCBieSBjaGVja2luZyB0aGUgYXJndW1lbnQgcGFzc2VkIGluLlxuICAvLyBBcmd1bWVudCBjYW4gYmUgYSBkZWZlcnJlZCAoZnVuY3Rpb24pIG9yIGltbWVkaWF0ZSB2YWx1ZSwgYW5kIGNhbiBiZSBzeW5jXG4gIC8vIG9yIGFzeW5jLlxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIGRlZiAtIHRoZSB2YWx1ZSB0byByZXR1cm4gaW4gY2FzZSBvcHRpb24gcmV0dXJucyB0byBub25lLiBJdCBjYW4gYmUgaW1tZWRhdGVcbiAgICogdmFsdWUgKGxpdGVyYWwpIG9yIGl0IGNhbiBiZSBkZWZlcnJlZCAoZnVuY3Rpb24gdGhhdCByZXR1cm5zIFQpLiBCb3RoIGNhbiBiZSBzeW5jIG9yXG4gICAqIGFzeW5jXG4gICAqIEByZXR1cm4ge1Byb21pc2U8VD59IFRoZSB1bmRlcmx5aW5nIHZhbHVlXG4gICAqL1xuICB1bndyYXBPcihkZWY6IFQgfCBQcm9taXNlPFQ+IHwgKCgpID0+IFQpIHwgKCgpID0+IFByb21pc2U8VD4pKTogUHJvbWlzZTxUPjtcblxuICAvLyBDb252ZXJ0cyBhbiBvcHRpb24gaW50byBhbiBFcnIgUmVzdWx0LiBVc2VyIG5lZWRzIHRvIHByb3ZpZGUgdGhlIE9rXG4gIC8vIFJlc3VsdCBpbiBjYXNlIHRoZSBvcHRpb24gcmVzb2x2ZXMgdG8gTm9uZVxuICAvKipcbiAgICogQHRlbXBsYXRlIE8sIFRcbiAgICogQHBhcmFtIHtPIHwgUHJvbWlzZTxPPn0gb2sgLSBPayB2YWx1ZSBpbiB0aGUgZXZlbnQgT3B0aW9uIHJlc29sdmVzIHRvIE5vbmVcbiAgICogQHJldHVybiB7UmVzdWx0PFQsRT59IC0gVGhlIG9wdGlvbiB2YWx1ZSBhcyBlcnIgcmVzdWx0XG4gICAqL1xuICBhc0VycjxPPihvazogTyB8IFByb21pc2U8Tz4pOiBSZXN1bHQ8TywgVD47XG5cbiAgLy8gQ29udmVydHMgYW4gb3B0aW9uIGludG8gYW4gT2sgUmVzdWx0LiBVc2VyIG5lZWRzIHRvIHByb3ZpZGUgdGhlIEVyclxuICAvLyBSZXN1bHQgaW4gY2FzZSB0aGUgb3B0aW9uIHJlc29sdmVzIHRvIE5vbmVcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBFLCBUXG4gICAqIEBwYXJhbSB7RSB8IFByb21pc2U8RT59IGVyciAtIEVycm9yIHZhbHVlIGluIHRoZSBldmVudCBPcHRpb24gcmVzb2x2ZXMgdG8gTm9uZVxuICAgKiBAcmV0dXJuIHtSZXN1bHQ8VCxFPn0gLSBUaGUgb3B0aW9uIHZhbHVlIGFzIG9rIHJlc3VsdFxuICAgKi9cbiAgYXNPazxFPihlcnI6IEUgfCBQcm9taXNlPEU+KTogUmVzdWx0PFQsIEU+O1xuXG4gIC8vIENvbnZlcnRzIGFuIG9wdGlvbiB0byBhIHJlc3VsdCwgYnkgbWFwcGluZyBib3RoIE5vbmUgYW5kIFNvbWUgdG8gYVxuICAvLyBzdGFuZGFyZCByZXN1bHQgdHlwZS5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBULCBPLCBFXG4gICAqIEBwYXJhbSBmbiAtIHRoZSBtYXBwZXIgZnVuY3Rpb25zIGZvciBTb21lIGFuZCBOb25lLiBBbGwgbWFwcGVyIGZ1bmN0aW9uc1xuICAgKiBjYW4gYmUgc3luYyBvciBhc3luYy4gQWRkaXRpb25hbGx5LCBOb25lIGFjY2VwdHMgbGl0ZXJhbCB2YWx1ZXMgaW5zdGVhZFxuICAgKiBvciBtYXBwZXJzXG4gICAqIEByZXR1cm5zIHtSZXN1bHQ8TyxFPn0gUmVzdWx0IGRlcml2ZWQgZnJvbSB0aGUgT3B0aW9uXG4gICAqL1xuICBhc1Jlc3VsdDxPLCBFPihmbjogUmVzdWx0TWF0Y2g8VCwgTywgRT4pOiBSZXN1bHQ8TywgRT47XG5cbiAgLy8gUnVucyB0aGUgZnVuY3Rpb24gcGFzc2VkIGluIGJ1dCBkb2VzIG5vdCBjYXB0dXJlIHRoZSByZXR1cm4gdmFsdWUuXG4gIC8vIEFjY2VwdHMgYm90aCBzeW5jIGFuZCBhc3luYyBmdW5jdGlvbnMuXG4gIC8vICoqRG9lcyBub3QgaGFuZGxlIGV4Y2VwdGlvbnMqKlxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHNpZGVFZmZlY3QgLSBTaWRlIGVmZmVjdCB0byBleGVjdXRlLiBDYW4gYmUgc3luYyBvciBhc3luY1xuICAgKiBAcmV0dXJucyB7T3B0aW9uPFQ+fSBPcmlnaW5hbCBPcHRpb25cbiAgICovXG4gIHJ1bihzaWRlRWZmZWN0OiAoKHQ6IFQpID0+IHZvaWQpIHwgKCh0OiBUKSA9PiBQcm9taXNlPHZvaWQ+KSk6IE9wdGlvbjxUPjtcblxuICAvLyBPYnRhaW4gdGhlIHVuZGVybHlpbmcgdmFsdWUgb3IgbmF0aXZlLCB3aGljaCBpcyB0aGUgbmF0aXZlIHZlcnNpb24gb2YgT3B0aW9uXG4gIG5hdGl2ZSgpOiBQcm9taXNlPFQgfCBudWxsPjtcbn1cblxudHlwZSBJU29tZTxUPiA9IFtcInNvbWVcIiwgVF07XG50eXBlIElOb25lID0gW1wibm9uZVwiLCBudWxsXTtcblxuY2xhc3MgS09wdGlvbjxUPiBpbXBsZW1lbnRzIE9wdGlvbjxUPiB7XG4gIHZhbHVlOiBQcm9taXNlPElTb21lPFQ+IHwgSU5vbmU+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHZhbHVlOiBQcm9taXNlPElTb21lPFQ+PiB8IFByb21pc2U8SU5vbmU+IHwgUHJvbWlzZTxJU29tZTxUPiB8IElOb25lPlxuICApIHtcbiAgICB0aGlzLnZhbHVlID0gUHJvbWlzZS5yZXNvbHZlKHZhbHVlKTtcbiAgfVxuXG4gIGFzeW5jIG5hdGl2ZSgpOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gICAgY29uc3QgWywgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIHJldHVybiB2O1xuICB9XG5cbiAgYW5kVGhlbjxVPihcbiAgICBmbjogKCh2OiBUKSA9PiBPcHRpb248VT4pIHwgKCh2OiBUKSA9PiBQcm9taXNlPE9wdGlvbjxVPj4pXG4gICk6IE9wdGlvbjxVPiB7XG4gICAgcmV0dXJuIG5ldyBLT3B0aW9uPFU+KFxuICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgW3R5cGUsIHZhbHVlXSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgICAgIGlmICh0eXBlID09PSBcIm5vbmVcIikge1xuICAgICAgICAgIHJldHVybiBbdHlwZSwgdmFsdWVdIGFzIElOb25lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IG1hcHBlZCA9IGF3YWl0IGZuKHZhbHVlKTtcbiAgICAgICAgICBjb25zdCBpc1NvbWUgPSBhd2FpdCBtYXBwZWQuaXNTb21lKCk7XG4gICAgICAgICAgaWYgKGlzU29tZSkge1xuICAgICAgICAgICAgY29uc3QgdiA9IGF3YWl0IG1hcHBlZC51bndyYXAoKTtcbiAgICAgICAgICAgIHJldHVybiBbXCJzb21lXCIsIHZdIGFzIElTb21lPFU+O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gW1wibm9uZVwiLCBudWxsXSBhcyBJTm9uZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pKClcbiAgICApO1xuICB9XG5cbiAgYXNFcnI8Tz4ob2s6IFByb21pc2U8Tz4gfCBPKTogUmVzdWx0PE8sIFQ+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8TywgVD4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodCA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICBjb25zdCBzID0gYXdhaXQgb2s7XG4gICAgICAgICAgcmV0dXJuIFtcIm9rXCIsIHNdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBbXCJlcnJcIiwgdl07XG4gICAgICAgIH1cbiAgICAgIH0pKClcbiAgICApO1xuICB9XG5cbiAgYXNPazxFPihlcnI6IFByb21pc2U8RT4gfCBFKTogUmVzdWx0PFQsIEU+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgRT4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodCA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICBjb25zdCBzID0gYXdhaXQgZXJyO1xuICAgICAgICAgIHJldHVybiBbXCJlcnJcIiwgc107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFtcIm9rXCIsIHZdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzUmVzdWx0PE8sIEU+KGZuOiBSZXN1bHRNYXRjaDxULCBPLCBFPik6IFJlc3VsdDxPLCBFPiB7XG4gICAgcmV0dXJuIG5ldyBLUmVzdWx0PG51bWJlciwgRT4oUHJvbWlzZS5yZXNvbHZlKFtcIm9rXCIsIDBdKSkuYW5kVGhlbihcbiAgICAgIGFzeW5jICgpOiBQcm9taXNlPFJlc3VsdDxPLCBFPj4gPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICByZXR1cm4gYXdhaXQgKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBpZiAodCA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4ubm9uZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGYgPSBmbi5ub25lO1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGYoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZuLm5vbmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZm4uc29tZSh2KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pKCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGlzTm9uZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBbdF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIHJldHVybiB0ID09PSBcIm5vbmVcIjtcbiAgfVxuXG4gIGFzeW5jIGlzU29tZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBbdF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIHJldHVybiB0ID09PSBcInNvbWVcIjtcbiAgfVxuXG4gIG1hcDxVPihmbjogKCh2YWw6IFQpID0+IFUpIHwgKCh2YWw6IFQpID0+IFByb21pc2U8VT4pKTogT3B0aW9uPFU+IHtcbiAgICByZXR1cm4gbmV3IEtPcHRpb248VT4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodCA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICByZXR1cm4gW3QsIHZdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGZ2ID0gYXdhaXQgZm4odik7XG4gICAgICAgICAgcmV0dXJuIFt0LCBmdl07XG4gICAgICAgIH1cbiAgICAgIH0pKClcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgbWF0Y2g8VT4oZm46IE1hdGNoPFQsIFU+KTogUHJvbWlzZTxVPiB7XG4gICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICBpZiAodCA9PT0gXCJzb21lXCIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm4uc29tZSh2KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgZm4ubm9uZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNvbnN0IGYgPSBmbi5ub25lIGFzICgoKSA9PiBVKSB8ICgoKSA9PiBQcm9taXNlPFU+KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmKCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmbi5ub25lKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBydW4oc2lkZUVmZmVjdDogKCh0OiBUKSA9PiB2b2lkKSB8ICgodDogVCkgPT4gUHJvbWlzZTx2b2lkPikpOiBPcHRpb248VD4ge1xuICAgIHJldHVybiBuZXcgS09wdGlvbihcbiAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IFt0LCB2XSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgICAgIGlmICh0ID09PSBcIm5vbmVcIikge1xuICAgICAgICAgIHJldHVybiBbdCwgdl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgc2lkZUVmZmVjdCh2KTtcbiAgICAgICAgICByZXR1cm4gW3QsIHZdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIHVud3JhcCgpOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIGlmICh0ID09PSBcInNvbWVcIikge1xuICAgICAgcmV0dXJuIHY7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBVbndyYXBFcnJvcihcbiAgICAgICAgXCJGYWlsZWQgdG8gdW53cmFwXCIsXG4gICAgICAgIFwib3B0aW9uXCIsXG4gICAgICAgIFwiRXhwZWN0ZWQgU29tZSBnb3QgTm9uZVwiXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVud3JhcE9yKFxuICAgIGRlZjogUHJvbWlzZTxUPiB8ICgoKSA9PiBUKSB8ICgoKSA9PiBQcm9taXNlPFQ+KSB8IFRcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICBpZiAodCA9PT0gXCJzb21lXCIpIHtcbiAgICAgIHJldHVybiB2O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGRlZiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNvbnN0IGYgPSBkZWYgYXMgKCgpID0+IFQpIHwgKCgpID0+IFByb21pc2U8VD4pO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGYoKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZGVmO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBTb21lPFQ+KHY6IFQpOiBPcHRpb248VD4ge1xuICByZXR1cm4gbmV3IEtPcHRpb24oUHJvbWlzZS5yZXNvbHZlKFtcInNvbWVcIiwgdl0pKTtcbn1cblxuZnVuY3Rpb24gTm9uZTxUPigpOiBPcHRpb248VD4ge1xuICByZXR1cm4gbmV3IEtPcHRpb248VD4oUHJvbWlzZS5yZXNvbHZlKFtcIm5vbmVcIiwgbnVsbF0pKTtcbn1cblxuZXhwb3J0IHsgT3B0aW9uLCBLT3B0aW9uLCBNYXRjaCwgUmVzdWx0TWF0Y2gsIFNvbWUsIE5vbmUsIElTb21lLCBJTm9uZSwgT3B0IH07XG4iXX0=