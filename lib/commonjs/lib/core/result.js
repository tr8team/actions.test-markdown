import { UnwrapError } from "./error.js";
import { KOption } from "./option.js";
// Creates a new instance of `Result` as the `err` variant.
/**
 * @template T,X
 * @param error - error to be converted to a Result
 * @returns {Result<T,X>} - new instance of `Result` as the `err` variant
 */
function Err(error) {
    return new KResult((async () => {
        const err = await error;
        return ["err", err];
    })());
}
// Creates a new instance of `Result` as the `ok` variant.
/**
 * @template T,X
 * @param val - value to be converted to a Result
 * @returns {Result<T,X>} - new instance of `Result` as the `ok` variant
 */
function Ok(val) {
    return new KResult((async () => {
        const v = await val;
        return ["ok", v];
    })());
}
class Res {
    // Resolve the promise of a result, Promise<Result<T, E>> to Result<T,E> without async/await
    /**
     * @template T,E
     * @param p - promise of a result to resolve
     * @returns {Result<T,E>} - resolved result
     */
    static fromAsync(p) {
        return new KResult((async () => {
            const r = await p;
            const isOk = await r.isOk();
            if (isOk) {
                const ok = await r.unwrap();
                return Promise.resolve(["ok", ok]);
            }
            else {
                const err = await r.unwrapErr();
                return Promise.resolve(["err", err]);
            }
        })());
    }
    // Create a Result from async function
    /**
     * @template T,E
     * @param fn - function that results in a Result, asynchronous
     * @returns {Result<T,E>} - resolved result
     */
    static async(fn) {
        return Res.fromAsync(fn());
    }
    // takes in a list of results and returns a new result with a list of ok values if all results are ok or a list of error values if at least one result is an error
    /**
     * @template
     * @param i - list of results
     */
    static all(...i) {
        const closure = async () => {
            const ok = [];
            const err = [];
            const r = i.map(async (e) => {
                const isOk = await e.isOk();
                if (isOk) {
                    const okR = await e.unwrap();
                    return ["ok", okR];
                }
                else {
                    const errR = await e.unwrapErr();
                    return ["err", errR];
                }
            });
            const a = await Promise.all(r);
            for (const [t, v] of a) {
                if (t === "ok") {
                    ok.push(v);
                }
                else {
                    err.push(v);
                }
            }
            if (err.length > 0) {
                return Err(err);
            }
            return Ok(ok);
        };
        return Res.fromAsync(closure());
    }
}
class KResult {
    value;
    constructor(value) {
        this.value = value;
    }
    andThen(fn) {
        const wrapped = async () => {
            const [type, val] = await this.value;
            if (type === "err") {
                return [type, val];
            }
            else {
                const mapped = await fn(val);
                const mType = await mapped.isOk();
                if (mType) {
                    const okVal = await Promise.resolve(mapped.unwrap());
                    return ["ok", okVal];
                }
                else {
                    const errVal = await Promise.resolve(mapped.unwrapErr());
                    return ["err", errVal];
                }
            }
        };
        return new KResult(wrapped());
    }
    async isOk() {
        const [type] = await this.value;
        return type === "ok";
    }
    async isErr() {
        const [type] = await this.value;
        return type === "err";
    }
    async unwrap() {
        const [type, val] = await this.value;
        if (type === "ok") {
            return val;
        }
        throw new UnwrapError("Failed to unwrap", "result", "Expected Ok got Error");
    }
    async unwrapErr() {
        const [type, val] = await this.value;
        if (type === "err") {
            return val;
        }
        throw new UnwrapError("Failed to unwrap", "result", "Expected Err got Ok");
    }
    map(mapper) {
        return new KResult((async () => {
            const [type, val] = await this.value;
            if (type === "ok") {
                const mapped = await mapper(val);
                return ["ok", mapped];
            }
            else {
                return ["err", val];
            }
        })());
    }
    mapErr(mapper) {
        return new KResult((async () => {
            const [type, val] = await this.value;
            if (type === "err") {
                const err = await mapper(val);
                return ["err", err];
            }
            else {
                return [type, val];
            }
        })());
    }
    async native() {
        const [, val] = await this.value;
        return val;
    }
    async match(fn) {
        const [type, val] = await this.value;
        if (type === "ok") {
            return Promise.resolve(fn.ok(val));
        }
        else {
            return Promise.resolve(fn.err(val));
        }
    }
    async unwrapOr(i) {
        const [type, val] = await this.value;
        if (type === "ok") {
            return val;
        }
        else {
            if (typeof i === "function") {
                const f = i;
                return f(val);
            }
            else {
                return Promise.resolve(i);
            }
        }
    }
    err() {
        const closure = async () => {
            const [t, v] = await this.value;
            if (t === "err") {
                return ["some", v];
            }
            else {
                return ["none", null];
            }
        };
        return new KOption(closure());
    }
    exec(sideEffect, mapper = (e) => {
        if (e instanceof Error) {
            return Promise.resolve(e);
        }
        else {
            return Promise.resolve(new Error(JSON.stringify(e)));
        }
    }) {
        const closure = async () => {
            const [t, v] = await this.value;
            if (t === "err") {
                const err = await mapper(v);
                return [t, err];
            }
            else {
                try {
                    await sideEffect(v);
                }
                catch (e) {
                    if (e instanceof Error) {
                        return ["err", e];
                    }
                    else if (typeof e === "string") {
                        return ["err", new Error(e)];
                    }
                    else {
                        return ["err", new Error(JSON.stringify(e))];
                    }
                }
                return [t, v];
            }
        };
        return new KResult(closure());
    }
    ok() {
        const closure = async () => {
            const [t, v] = await this.value;
            if (t === "ok") {
                return ["some", v];
            }
            else {
                return ["none", null];
            }
        };
        return new KOption(closure());
    }
    run(sideEffect) {
        return new KResult((async () => {
            const [t, v] = await this.value;
            if (t === "err") {
                return [t, v];
            }
            else {
                await sideEffect(v);
                return [t, v];
            }
        })());
    }
}
export { Err, Ok, Res, KResult };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdWx0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3Jlc3VsdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3pDLE9BQU8sRUFBZ0IsT0FBTyxFQUFVLE1BQU0sYUFBYSxDQUFDO0FBRTVELDJEQUEyRDtBQUMzRDs7OztHQUlHO0FBQ0gsU0FBUyxHQUFHLENBQU8sS0FBcUI7SUFDdEMsT0FBTyxJQUFJLE9BQU8sQ0FDaEIsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNWLE1BQU0sR0FBRyxHQUFHLE1BQU0sS0FBSyxDQUFDO1FBQ3hCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdEIsQ0FBQyxDQUFDLEVBQUUsQ0FDTCxDQUFDO0FBQ0osQ0FBQztBQUVELDBEQUEwRDtBQUMxRDs7OztHQUlHO0FBQ0gsU0FBUyxFQUFFLENBQWUsR0FBbUI7SUFDM0MsT0FBTyxJQUFJLE9BQU8sQ0FDaEIsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNWLE1BQU0sQ0FBQyxHQUFHLE1BQU0sR0FBRyxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkIsQ0FBQyxDQUFDLEVBQUUsQ0FDTCxDQUFDO0FBQ0osQ0FBQztBQXFCRCxNQUFNLEdBQUc7SUFDUCw0RkFBNEY7SUFDNUY7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxTQUFTLENBQU8sQ0FBd0I7UUFDN0MsT0FBTyxJQUFJLE9BQU8sQ0FDaEIsQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNWLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzVCLElBQUksSUFBSSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDLE1B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fSBmcm9tIFwiLi9lcnJvci5qc1wiO1xuaW1wb3J0IHsgSU5vbmUsIElTb21lLCBLT3B0aW9uLCBPcHRpb24gfSBmcm9tIFwiLi9vcHRpb24uanNcIjtcblxuLy8gQ3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiBgUmVzdWx0YCBhcyB0aGUgYGVycmAgdmFyaWFudC5cbi8qKlxuICogQHRlbXBsYXRlIFQsWFxuICogQHBhcmFtIGVycm9yIC0gZXJyb3IgdG8gYmUgY29udmVydGVkIHRvIGEgUmVzdWx0XG4gKiBAcmV0dXJucyB7UmVzdWx0PFQsWD59IC0gbmV3IGluc3RhbmNlIG9mIGBSZXN1bHRgIGFzIHRoZSBgZXJyYCB2YXJpYW50XG4gKi9cbmZ1bmN0aW9uIEVycjxULCBYPihlcnJvcjogWCB8IFByb21pc2U8WD4pOiBSZXN1bHQ8VCwgWD4ge1xuICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgWD4oXG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVyciA9IGF3YWl0IGVycm9yO1xuICAgICAgcmV0dXJuIFtcImVyclwiLCBlcnJdO1xuICAgIH0pKClcbiAgKTtcbn1cblxuLy8gQ3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiBgUmVzdWx0YCBhcyB0aGUgYG9rYCB2YXJpYW50LlxuLyoqXG4gKiBAdGVtcGxhdGUgVCxYXG4gKiBAcGFyYW0gdmFsIC0gdmFsdWUgdG8gYmUgY29udmVydGVkIHRvIGEgUmVzdWx0XG4gKiBAcmV0dXJucyB7UmVzdWx0PFQsWD59IC0gbmV3IGluc3RhbmNlIG9mIGBSZXN1bHRgIGFzIHRoZSBgb2tgIHZhcmlhbnRcbiAqL1xuZnVuY3Rpb24gT2s8VCwgWCA9IG5ldmVyPih2YWw6IFQgfCBQcm9taXNlPFQ+KTogUmVzdWx0PFQsIFg+IHtcbiAgcmV0dXJuIG5ldyBLUmVzdWx0PFQsIFg+KFxuICAgIChhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB2ID0gYXdhaXQgdmFsO1xuICAgICAgcmV0dXJuIFtcIm9rXCIsIHZdO1xuICAgIH0pKClcbiAgKTtcbn1cblxuaW50ZXJmYWNlIE1hdGNoPFQsIEUsIFU+IHtcbiAgb2s6ICgodmFsOiBUKSA9PiBQcm9taXNlPFU+KSB8ICgodmFsOiBUKSA9PiBVKTtcbiAgZXJyOiAoKHZhbDogRSkgPT4gUHJvbWlzZTxVPikgfCAoKHZhbDogRSkgPT4gVSk7XG59XG5cbnR5cGUgUmVzdWx0RXJyPFQgZXh0ZW5kcyBSZXN1bHQ8dW5rbm93biwgdW5rbm93bj5bXT4gPSBUIGV4dGVuZHMgQXJyYXk8XG4gICAgUmVzdWx0PHVua25vd24sIGluZmVyIEU+XG4gID5cbiAgPyBFW11cbiAgOiBuZXZlcjtcblxudHlwZSBSZXN1bHRPazxUIGV4dGVuZHMgUmVzdWx0PHVua25vd24sIHVua25vd24+W10+ID0ge1xuICBbSyBpbiBrZXlvZiBUXTogSyBleHRlbmRzIG51bWJlclxuICAgID8gVFtLXSBleHRlbmRzIFJlc3VsdDxpbmZlciBVLCB1bmtub3duPlxuICAgICAgPyBVXG4gICAgICA6IG5ldmVyXG4gICAgOiBuZXZlcjtcbn07XG5cbmNsYXNzIFJlcyB7XG4gIC8vIFJlc29sdmUgdGhlIHByb21pc2Ugb2YgYSByZXN1bHQsIFByb21pc2U8UmVzdWx0PFQsIEU+PiB0byBSZXN1bHQ8VCxFPiB3aXRob3V0IGFzeW5jL2F3YWl0XG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVCxFXG4gICAqIEBwYXJhbSBwIC0gcHJvbWlzZSBvZiBhIHJlc3VsdCB0byByZXNvbHZlXG4gICAqIEByZXR1cm5zIHtSZXN1bHQ8VCxFPn0gLSByZXNvbHZlZCByZXN1bHRcbiAgICovXG4gIHN0YXRpYyBmcm9tQXN5bmM8VCwgRT4ocDogUHJvbWlzZTxSZXN1bHQ8VCwgRT4+KTogUmVzdWx0PFQsIEU+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgRT4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByID0gYXdhaXQgcDtcbiAgICAgICAgY29uc3QgaXNPayA9IGF3YWl0IHIuaXNPaygpO1xuICAgICAgICBpZiAoaXNPaykge1xuICAgICAgICAgIGNvbnN0IG9rID0gYXdhaXQgci51bndyYXAoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtcIm9rXCIsIG9rXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgZXJyID0gYXdhaXQgci51bndyYXBFcnIoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtcImVyclwiLCBlcnJdKTtcbiAgICAgICAgfVxuICAgICAgfSkoKVxuICAgICk7XG4gIH1cblxuICAvLyBDcmVhdGUgYSBSZXN1bHQgZnJvbSBhc3luYyBmdW5jdGlvblxuICAvKipcbiAgICogQHRlbXBsYXRlIFQsRVxuICAgKiBAcGFyYW0gZm4gLSBmdW5jdGlvbiB0aGF0IHJlc3VsdHMgaW4gYSBSZXN1bHQsIGFzeW5jaHJvbm91c1xuICAgKiBAcmV0dXJucyB7UmVzdWx0PFQsRT59IC0gcmVzb2x2ZWQgcmVzdWx0XG4gICAqL1xuICBzdGF0aWMgYXN5bmM8VCwgRT4oZm46ICgpID0+IFByb21pc2U8UmVzdWx0PFQsIEU+Pik6IFJlc3VsdDxULCBFPiB7XG4gICAgcmV0dXJuIFJlcy5mcm9tQXN5bmMoZm4oKSk7XG4gIH1cblxuICAvLyB0YWtlcyBpbiBhIGxpc3Qgb2YgcmVzdWx0cyBhbmQgcmV0dXJucyBhIG5ldyByZXN1bHQgd2l0aCBhIGxpc3Qgb2Ygb2sgdmFsdWVzIGlmIGFsbCByZXN1bHRzIGFyZSBvayBvciBhIGxpc3Qgb2YgZXJyb3IgdmFsdWVzIGlmIGF0IGxlYXN0IG9uZSByZXN1bHQgaXMgYW4gZXJyb3JcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZVxuICAgKiBAcGFyYW0gaSAtIGxpc3Qgb2YgcmVzdWx0c1xuICAgKi9cbiAgc3RhdGljIGFsbDxUIGV4dGVuZHMgUmVzdWx0PHVua25vd24sIHVua25vd24+W10+KFxuICAgIC4uLmk6IFsuLi5UXVxuICApOiBSZXN1bHQ8UmVzdWx0T2s8VD4sIFJlc3VsdEVycjxUPj4ge1xuICAgIGNvbnN0IGNsb3N1cmUgPSBhc3luYyAoKTogUHJvbWlzZTxSZXN1bHQ8UmVzdWx0T2s8VD4sIFJlc3VsdEVycjxUPj4+ID0+IHtcbiAgICAgIGNvbnN0IG9rOiBSZXN1bHRPazxUPiA9IFtdIGFzIHVua25vd24gYXMgUmVzdWx0T2s8VD47XG4gICAgICBjb25zdCBlcnI6IFJlc3VsdEVycjxUPiA9IFtdIGFzIHVua25vd24gYXMgUmVzdWx0RXJyPFQ+O1xuICAgICAgY29uc3QgciA9IGkubWFwKGFzeW5jIChlKSA9PiB7XG4gICAgICAgIGNvbnN0IGlzT2sgPSBhd2FpdCBlLmlzT2soKTtcbiAgICAgICAgaWYgKGlzT2spIHtcbiAgICAgICAgICBjb25zdCBva1IgPSBhd2FpdCBlLnVud3JhcCgpO1xuICAgICAgICAgIHJldHVybiBbXCJva1wiLCBva1JdIGFzIFtcIm9rXCIsIFJlc3VsdE9rPFQ+W251bWJlcl1dO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGVyclIgPSBhd2FpdCBlLnVud3JhcEVycigpO1xuICAgICAgICAgIHJldHVybiBbXCJlcnJcIiwgZXJyUl0gYXMgW1wiZXJyXCIsIFJlc3VsdEVycjxUPltudW1iZXJdXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBhID0gYXdhaXQgUHJvbWlzZS5hbGwocik7XG4gICAgICBmb3IgKGNvbnN0IFt0LCB2XSBvZiBhKSB7XG4gICAgICAgIGlmICh0ID09PSBcIm9rXCIpIHtcbiAgICAgICAgICBvay5wdXNoKHYpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVyci5wdXNoKHYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoZXJyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIEVycihlcnIpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIE9rKG9rKTtcbiAgICB9O1xuICAgIHJldHVybiBSZXMuZnJvbUFzeW5jKGNsb3N1cmUoKSk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIFJlc3VsdDxULCBFPiB7XG4gIC8vIHJldHVybnMgYSBQcm9taXNlIG9mIGEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHZhcmlhbnQgb2YgdGhlIFJlc3VsdCBpcyBcIm9rXCJcbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB2YXJpYW50IG9mIHRoZSBSZXN1bHQgaXMgXCJva1wiXG4gICAqL1xuICBpc09rKCk6IFByb21pc2U8Ym9vbGVhbj47XG5cbiAgLy8gcmV0dXJucyBhIFByb21pc2Ugb2YgYSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgdmFyaWFudCBvZiB0aGUgUmVzdWx0IGlzIFwiZXJyXCJcbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB2YXJpYW50IG9mIHRoZSBSZXN1bHQgaXMgXCJlcnJcIlxuICAgKi9cbiAgaXNFcnIoKTogUHJvbWlzZTxib29sZWFuPjtcblxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHJldHVybnMge1Byb21pc2U8VD59IC0gcHJvbWlzZSBvZiB0aGUgdW53cmFwcGVkIHZhbHVlXG4gICAqIEB0aHJvd3Mge1Vud3JhcEVycm9yfSAtIGlmIHRoZSB2YXJpYW50IG9mIHRoZSBSZXN1bHQgaXMgXCJlcnJcIlxuICAgKi9cbiAgLy8gcmV0dXJucyBhIFByb21pc2Ugb2YgdGhlIHZhbHVlIG9mIHRoZSBSZXN1bHQgaWYgaXRzIHZhcmlhbnQgaXMgXCJva1wiLiBJZiBpdHMgdmFyaWFudCBpcyBcImVyclwiLCBpdCB0aHJvd3MgYW4gZXJyb3IuXG4gIHVud3JhcCgpOiBQcm9taXNlPFQ+O1xuXG4gIC8vIHJldHVybnMgYSBQcm9taXNlIG9mIHRoZSB2YWx1ZSBvZiB0aGUgUmVzdWx0IGlmIGl0cyB2YXJpYW50IGlzIFwib2tcIiwgb3RoZXJ3aXNlIGl0IHJldHVybnMgdGhlIHByb3ZpZGVkIGRlZmF1bHQgdmFsdWUuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0gaSAtIGRlZmF1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQgaWYgdGhlIHZhcmlhbnQgb2YgdGhlIFJlc3VsdCBpcyBcImVyclwiLiBJdCBjYW4gYmUgdGhlIGRlZmF1bHQgdmFsdWUsIHByb21pc2VkIHZhbHVlLCBvciBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGRlZmF1bHQgdmFsdWUgb3IgYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBkZWZhdWx0IHZhbHVlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFQ+fSAtIHByb21pc2Ugb2YgdGhlIHVud3JhcHBlZCB2YWx1ZVxuICAgKi9cbiAgdW53cmFwT3IoXG4gICAgaTogVCB8IFByb21pc2U8VD4gfCAoKGVycjogRSkgPT4gUHJvbWlzZTxUPikgfCAoKGVycjogRSkgPT4gVClcbiAgKTogUHJvbWlzZTxUPjtcblxuICAvLyByZXR1cm5zIGEgUHJvbWlzZSBvZiB0aGUgZXJyb3IgdmFsdWUgb2YgdGhlIFJlc3VsdCBpZiBpdHMgdmFyaWFudCBpcyBcImVyclwiLiBJZiBpdHMgdmFyaWFudCBpcyBcIm9rXCIsIGl0IHRocm93cyBhbiBlcnJvclxuICAvKipcbiAgICogQHRlbXBsYXRlIEVcbiAgICogQHJldHVybnMge1Byb21pc2U8RT59IC0gcHJvbWlzZSBvZiB0aGUgdW53cmFwcGVkIGVycm9yIHZhbHVlXG4gICAqIEB0aHJvd3Mge1Vud3JhcEVycm9yfSAtIGlmIHRoZSB2YXJpYW50IG9mIHRoZSBSZXN1bHQgaXMgXCJva1wiXG4gICAqL1xuICB1bndyYXBFcnIoKTogUHJvbWlzZTxFPjtcblxuICAvLyBhcHBsaWVzIGEgbWFwcGVyIGZ1bmN0aW9uIHRvIHRoZSB2YWx1ZSBvZiB0aGUgUmVzdWx0IGlmIGl0cyB2YXJpYW50IGlzIFwib2tcIiBhbmQgcmV0dXJucyBhIG5ldyBSZXN1bHQgd2l0aCB0aGUgbWFwcGVkIHZhbHVlLiBJZiBpdHMgdmFyaWFudCBpcyBcImVyclwiLCBpdCByZXR1cm5zIHRoZSBvcmlnaW5hbCBSZXN1bHQuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgWSwgRVxuICAgKiBAcGFyYW0gbWFwcGVyIC0gZnVuY3Rpb24gdG8gbWFwIHRoZSB2YWx1ZSBvZiB0aGUgUmVzdWx0LiBtYXBwZXIgY2FuIGJlIGFzeW5jLlxuICAgKiBAcmV0dXJucyB7UmVzdWx0PFksRT59IC0gbmV3IFJlc3VsdCB3aXRoIHRoZSBtYXBwZWQgdmFsdWVcbiAgICovXG4gIG1hcDxZPihtYXBwZXI6ICgoYTogVCkgPT4gUHJvbWlzZTxZPikgfCAoKGE6IFQpID0+IFkpKTogUmVzdWx0PFksIEU+O1xuXG4gIC8vIGFwcGxpZXMgYSBtYXBwZXIgZnVuY3Rpb24gdG8gdGhlIGVycm9yIHZhbHVlIG9mIHRoZSBSZXN1bHQgaWYgaXRzIHZhcmlhbnQgaXMgXCJlcnJcIiBhbmQgcmV0dXJucyBhIG5ldyBSZXN1bHQgd2l0aCB0aGUgbWFwcGVkIGVycm9yIHZhbHVlLiBJZiBpdHMgdmFyaWFudCBpcyBcIm9rXCIsIGl0IHJldHVybnMgdGhlIG9yaWdpbmFsIFJlc3VsdC5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBZLCBUXG4gICAqIEBwYXJhbSBtYXBwZXIgLSBmdW5jdGlvbiB0byBtYXAgdGhlIGVycm9yIHZhbHVlIG9mIHRoZSBSZXN1bHQuIG1hcHBlciBjYW4gYmUgYXN5bmMuXG4gICAqIEByZXR1cm5zIHtSZXN1bHQ8VCxZPn0gLSBuZXcgUmVzdWx0IHdpdGggdGhlIG1hcHBlZCBlcnJvciB2YWx1ZVxuICAgKi9cbiAgbWFwRXJyPFk+KG1hcHBlcjogKChhOiBFKSA9PiBQcm9taXNlPFk+KSB8ICgoYTogRSkgPT4gWSkpOiBSZXN1bHQ8VCwgWT47XG5cbiAgLy8gcmV0dXJucyBhIFByb21pc2Ugb2YgdGhlIHZhbHVlIG9yIGVycm9yIG9mIHRoZSBSZXN1bHQgcmVnYXJkbGVzcyBvZiBpdHMgdmFyaWFudC5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBULCBFXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFQgfCBFPn0gLSBwcm9taXNlIG9mIHRoZSB2YWx1ZSBvciBlcnJvciBvZiB0aGUgUmVzdWx0XG4gICAqL1xuICBuYXRpdmUoKTogUHJvbWlzZTxUIHwgRT47XG5cbiAgLy8gbWV0aG9kIHRoYXQgdGFrZXMgaW4gYSBmdW5jdGlvbiBmbiB3aXRoIG9rIGFuZCBlcnIgY2FzZXMuIEl0IGFwcGxpZXMgdGhlIGNvcnJlc3BvbmRpbmcgY2FzZSBiYXNlZCBvbiB0aGUgdmFyaWFudCBvZiB0aGUgUmVzdWx0IGFuZCByZXR1cm5zIHRoZSByZXN1bHQgb2YgdGhhdCBjYXNlIGFzIGEgUHJvbWlzZS5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBVXG4gICAqIEBwYXJhbSBmbiAtIGZ1bmN0aW9uIHdpdGggb2sgYW5kIGVyciBjYXNlc1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxVPn0gLSBwcm9taXNlIG9mIHRoZSByZXN1bHQgb2YgdGhlIGNvcnJlc3BvbmRpbmcgY2FzZVxuICAgKi9cbiAgbWF0Y2g8VT4oZm46IE1hdGNoPFQsIEUsIFU+KTogUHJvbWlzZTxVPjtcblxuICAvLyBUYWtlcyBpbiBhIGZ1bmN0aW9uIHRoYXQgbWFwcyB0aGUgb2sgdmFsdWUgb2YgdGhlIFJlc3VsdCB0byBhIG5ldyBSZXN1bHQsIGlmIHRoZSBSZXN1bHQgaXMgb2suXG4gIC8vIFJldHVybnMgdGhlIG5ldyBSZXN1bHQgdGhhdCB3YXMgbWFwcGVkIGZyb20gdGhlIG9yaWdpbmFsIFJlc3VsdC5cbiAgLy8gSWYgdGhlIFJlc3VsdCBpcyBhbiBlcnJvciwgdGhlIGZ1bmN0aW9uIGlzIG5vdCBjYWxsZWQsIGFuZCB0aGUgb3JpZ2luYWwgZXJyb3IgUmVzdWx0IGlzIHJldHVybmVkLlxuICAvKipcbiAgICogQHRlbXBsYXRlIFVcbiAgICogQHBhcmFtIGZuIC0gZnVuY3Rpb24gdGhhdCBtYXBzIHRoZSBvayB2YWx1ZSBvZiB0aGUgUmVzdWx0IHRvIGEgbmV3IFJlc3VsdC4gZm4gY2FuIGJlIGFzeW5jLlxuICAgKiBAcmV0dXJucyB7UmVzdWx0PFUsRT59IC0gbmV3IFJlc3VsdCB0aGF0IHdhcyBtYXBwZWQgZnJvbSB0aGUgb3JpZ2luYWwgUmVzdWx0XG4gICAqL1xuICBhbmRUaGVuPFU+KFxuICAgIGZuOiAoKHZhbDogVCkgPT4gUmVzdWx0PFUsIEU+KSB8ICgodmFsOiBUKSA9PiBQcm9taXNlPFJlc3VsdDxVLCBFPj4pXG4gICk6IFJlc3VsdDxVLCBFPjtcblxuICAvLyBSdW5zIHRoZSBmdW5jdGlvbiBwYXNzZWQgaW4gYnV0IGRvZXMgbm90IGNhcHR1cmUgdGhlIHJldHVybiB2YWx1ZS5cbiAgLy8gQWNjZXB0cyBib3RoIHN5bmMgYW5kIGFzeW5jIGZ1bmN0aW9ucy5cbiAgLy8gKipEb2VzIG5vdCBoYW5kbGUgZXhjZXB0aW9ucyoqXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0gc2lkZUVmZmVjdCAtIFNpZGUgZWZmZWN0IHRvIGV4ZWN1dGUuIENhbiBiZSBzeW5jIG9yIGFzeW5jXG4gICAqIEByZXR1cm5zIHtSZXN1bHQ8VCxFPn0gLSBvcmlnaW5hbCBSZXN1bHRcbiAgICovXG4gIHJ1bihzaWRlRWZmZWN0OiAoKHQ6IFQpID0+IHZvaWQpIHwgKCh0OiBUKSA9PiBQcm9taXNlPHZvaWQ+KSk6IFJlc3VsdDxULCBFPjtcblxuICAvLyBSdW5zIHRoZSBmdW5jdGlvbiBwYXNzZWQgaW4gYnV0IGRvZXMgbm90IGNhcHR1cmUgdGhlIHJldHVybiB2YWx1ZS5cbiAgLy8gQWNjZXB0cyBib3RoIHN5bmMgYW5kIGFzeW5jIGZ1bmN0aW9ucy5cbiAgLy8gKipIYW5kbGVzIGV4Y2VwdGlvbnMqKlxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHNpZGVFZmZlY3QgIC0gU2lkZSBlZmZlY3QgdG8gZXhlY3V0ZS4gQ2FuIGJlIHN5bmMgb3IgYXN5bmNcbiAgICogQHBhcmFtIG1hcHBlciAtIGZ1bmN0aW9uIHRvIG1hcCB0aGUgZXJyb3IgdmFsdWUgb2YgdGhlIFJlc3VsdC4gbWFwcGVyIGNhbiBiZSBhc3luYy5cbiAgICogQHJldHVybnMge1Jlc3VsdDxULEU+fSAtIG9yaWdpbmFsIFJlc3VsdFxuICAgKi9cbiAgZXhlYyhcbiAgICBzaWRlRWZmZWN0OiAoKHQ6IFQpID0+IHZvaWQpIHwgKCh0OiBUKSA9PiBQcm9taXNlPHZvaWQ+KSxcbiAgICBtYXBwZXI/OiAoZTogRSkgPT4gRXJyb3IgfCBQcm9taXNlPEVycm9yPlxuICApOiBSZXN1bHQ8VCwgRXJyb3I+O1xuXG4gIC8vIFJldHVybnMgYW4gT3B0aW9uIG9mIHRoZSBPayByZXN1bHQuIEVycm9yIHdpbGwgcmVzdWx0IGluIE5vbmVcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEByZXR1cm5zIHtPcHRpb248VD59IC0gT3B0aW9uIG9mIHRoZSBPayByZXN1bHRcbiAgICovXG4gIG9rKCk6IE9wdGlvbjxUPjtcblxuICAvLyBSZXR1cm5zIGFuIE9wdGlvbiBvZiB0aGUgRXJyb3IgcmVzdWx0LiBPayB3aWxsIHJlc3VsdCBpbiBOb25lXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgRVxuICAgKiBAcmV0dXJucyB7T3B0aW9uPEU+fSAtIE9wdGlvbiBvZiB0aGUgRXJyb3IgcmVzdWx0XG4gICAqL1xuICBlcnIoKTogT3B0aW9uPEU+O1xufVxuXG5jbGFzcyBLUmVzdWx0PFQsIFg+IGltcGxlbWVudHMgUmVzdWx0PFQsIFg+IHtcbiAgdmFsdWU6XG4gICAgfCBQcm9taXNlPFtcIm9rXCIsIFRdPlxuICAgIHwgUHJvbWlzZTxbXCJlcnJcIiwgWF0+XG4gICAgfCBQcm9taXNlPFtcImVyclwiLCBYXSB8IFtcIm9rXCIsIFRdPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICB2YWx1ZTpcbiAgICAgIHwgUHJvbWlzZTxbXCJva1wiLCBUXT5cbiAgICAgIHwgUHJvbWlzZTxbXCJlcnJcIiwgWF0+XG4gICAgICB8IFByb21pc2U8W1wiZXJyXCIsIFhdIHwgW1wib2tcIiwgVF0+XG4gICkge1xuICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgfVxuXG4gIGFuZFRoZW48VT4oXG4gICAgZm46ICgodmFsOiBUKSA9PiBSZXN1bHQ8VSwgWD4pIHwgKCh2YWw6IFQpID0+IFByb21pc2U8UmVzdWx0PFUsIFg+PilcbiAgKTogUmVzdWx0PFUsIFg+IHtcbiAgICBjb25zdCB3cmFwcGVkID0gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgW3R5cGUsIHZhbF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgaWYgKHR5cGUgPT09IFwiZXJyXCIpIHtcbiAgICAgICAgcmV0dXJuIFt0eXBlLCB2YWxdIGFzIFtcImVyclwiLCBYXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG1hcHBlZCA9IGF3YWl0IGZuKHZhbCk7XG4gICAgICAgIGNvbnN0IG1UeXBlID0gYXdhaXQgbWFwcGVkLmlzT2soKTtcbiAgICAgICAgaWYgKG1UeXBlKSB7XG4gICAgICAgICAgY29uc3Qgb2tWYWwgPSBhd2FpdCBQcm9taXNlLnJlc29sdmUobWFwcGVkLnVud3JhcCgpKTtcbiAgICAgICAgICByZXR1cm4gW1wib2tcIiwgb2tWYWxdIGFzIFtcIm9rXCIsIFVdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGVyclZhbCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShtYXBwZWQudW53cmFwRXJyKCkpO1xuICAgICAgICAgIHJldHVybiBbXCJlcnJcIiwgZXJyVmFsXSBhcyBbXCJlcnJcIiwgWF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBuZXcgS1Jlc3VsdDxVLCBYPih3cmFwcGVkKCkpO1xuICB9XG5cbiAgYXN5bmMgaXNPaygpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBbdHlwZV0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIHJldHVybiB0eXBlID09PSBcIm9rXCI7XG4gIH1cblxuICBhc3luYyBpc0VycigpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBbdHlwZV0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIHJldHVybiB0eXBlID09PSBcImVyclwiO1xuICB9XG5cbiAgYXN5bmMgdW53cmFwKCk6IFByb21pc2U8VD4gfCBuZXZlciB7XG4gICAgY29uc3QgW3R5cGUsIHZhbF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIGlmICh0eXBlID09PSBcIm9rXCIpIHtcbiAgICAgIHJldHVybiB2YWw7XG4gICAgfVxuICAgIHRocm93IG5ldyBVbndyYXBFcnJvcihcbiAgICAgIFwiRmFpbGVkIHRvIHVud3JhcFwiLFxuICAgICAgXCJyZXN1bHRcIixcbiAgICAgIFwiRXhwZWN0ZWQgT2sgZ290IEVycm9yXCJcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdW53cmFwRXJyKCk6IFByb21pc2U8WD4gfCBuZXZlciB7XG4gICAgY29uc3QgW3R5cGUsIHZhbF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIGlmICh0eXBlID09PSBcImVyclwiKSB7XG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgVW53cmFwRXJyb3IoXCJGYWlsZWQgdG8gdW53cmFwXCIsIFwicmVzdWx0XCIsIFwiRXhwZWN0ZWQgRXJyIGdvdCBPa1wiKTtcbiAgfVxuXG4gIG1hcDxZPihtYXBwZXI6ICgoYTogVCkgPT4gUHJvbWlzZTxZPikgfCAoKGE6IFQpID0+IFkpKTogUmVzdWx0PFksIFg+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8WSwgWD4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdHlwZSwgdmFsXSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgICAgIGlmICh0eXBlID09PSBcIm9rXCIpIHtcbiAgICAgICAgICBjb25zdCBtYXBwZWQ6IFkgPSBhd2FpdCBtYXBwZXIodmFsKTtcbiAgICAgICAgICByZXR1cm4gW1wib2tcIiwgbWFwcGVkXSBhcyBbXCJva1wiLCBZXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gW1wiZXJyXCIsIHZhbF0gYXMgW1wiZXJyXCIsIFhdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIG1hcEVycjxZPihtYXBwZXI6ICgoYTogWCkgPT4gUHJvbWlzZTxZPikgfCAoKGE6IFgpID0+IFkpKTogUmVzdWx0PFQsIFk+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgWT4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdHlwZSwgdmFsXSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgICAgIGlmICh0eXBlID09PSBcImVyclwiKSB7XG4gICAgICAgICAgY29uc3QgZXJyID0gYXdhaXQgbWFwcGVyKHZhbCk7XG4gICAgICAgICAgcmV0dXJuIFtcImVyclwiLCBlcnJdIGFzIFtcImVyclwiLCBZXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gW3R5cGUsIHZhbF0gYXMgW1wib2tcIiwgVF07XG4gICAgICAgIH1cbiAgICAgIH0pKClcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgbmF0aXZlKCk6IFByb21pc2U8VCB8IFg+IHtcbiAgICBjb25zdCBbLCB2YWxdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgYXN5bmMgbWF0Y2g8VT4oZm46IE1hdGNoPFQsIFgsIFU+KTogUHJvbWlzZTxVPiB7XG4gICAgY29uc3QgW3R5cGUsIHZhbF0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgIGlmICh0eXBlID09PSBcIm9rXCIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm4ub2sodmFsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm4uZXJyKHZhbCkpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVud3JhcE9yKFxuICAgIGk6IFByb21pc2U8VD4gfCAoKGVycjogWCkgPT4gUHJvbWlzZTxUPikgfCAoKGVycjogWCkgPT4gVCkgfCBUXG4gICk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IFt0eXBlLCB2YWxdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICBpZiAodHlwZSA9PT0gXCJva1wiKSB7XG4gICAgICByZXR1cm4gdmFsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjb25zdCBmID0gaSBhcyAoKGVycjogWCkgPT4gUHJvbWlzZTxUPikgfCAoKGVycjogWCkgPT4gVCk7XG4gICAgICAgIHJldHVybiBmKHZhbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGVycigpOiBPcHRpb248WD4ge1xuICAgIGNvbnN0IGNsb3N1cmUgPSBhc3luYyAoKTogUHJvbWlzZTxJU29tZTxYPiB8IElOb25lPiA9PiB7XG4gICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgaWYgKHQgPT09IFwiZXJyXCIpIHtcbiAgICAgICAgcmV0dXJuIFtcInNvbWVcIiwgdl0gYXMgW1wic29tZVwiLCBYXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBbXCJub25lXCIsIG51bGxdIGFzIFtcIm5vbmVcIiwgbnVsbF07XG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gbmV3IEtPcHRpb248WD4oY2xvc3VyZSgpKTtcbiAgfVxuXG4gIGV4ZWMoXG4gICAgc2lkZUVmZmVjdDogKCh0OiBUKSA9PiB2b2lkKSB8ICgodDogVCkgPT4gUHJvbWlzZTx2b2lkPiksXG4gICAgbWFwcGVyOiAoZTogWCkgPT4gRXJyb3IgfCBQcm9taXNlPEVycm9yPiA9IChlOiBYKSA9PiB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeShlKSkpO1xuICAgICAgfVxuICAgIH1cbiAgKTogUmVzdWx0PFQsIEVycm9yPiB7XG4gICAgY29uc3QgY2xvc3VyZSA9IGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IFt0LCB2XSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgICBpZiAodCA9PT0gXCJlcnJcIikge1xuICAgICAgICBjb25zdCBlcnIgPSBhd2FpdCBtYXBwZXIodik7XG4gICAgICAgIHJldHVybiBbdCwgZXJyXSBhcyBbXCJlcnJcIiwgRXJyb3JdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBzaWRlRWZmZWN0KHYpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIFtcImVyclwiLCBlXSBhcyBbXCJlcnJcIiwgRXJyb3JdO1xuICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBbXCJlcnJcIiwgbmV3IEVycm9yKGUpXSBhcyBbXCJlcnJcIiwgRXJyb3JdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gW1wiZXJyXCIsIG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeShlKSldIGFzIFtcImVyclwiLCBFcnJvcl07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbdCwgdl0gYXMgW1wib2tcIiwgVF07XG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgRXJyb3I+KGNsb3N1cmUoKSk7XG4gIH1cblxuICBvaygpOiBPcHRpb248VD4ge1xuICAgIGNvbnN0IGNsb3N1cmUgPSBhc3luYyAoKTogUHJvbWlzZTxJU29tZTxUPiB8IElOb25lPiA9PiB7XG4gICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgaWYgKHQgPT09IFwib2tcIikge1xuICAgICAgICByZXR1cm4gW1wic29tZVwiLCB2XSBhcyBbXCJzb21lXCIsIFRdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFtcIm5vbmVcIiwgbnVsbF0gYXMgW1wibm9uZVwiLCBudWxsXTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBuZXcgS09wdGlvbjxUPihjbG9zdXJlKCkpO1xuICB9XG5cbiAgcnVuKHNpZGVFZmZlY3Q6ICgodDogVCkgPT4gdm9pZCkgfCAoKHQ6IFQpID0+IFByb21pc2U8dm9pZD4pKTogUmVzdWx0PFQsIFg+IHtcbiAgICByZXR1cm4gbmV3IEtSZXN1bHQ8VCwgWD4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodCA9PT0gXCJlcnJcIikge1xuICAgICAgICAgIHJldHVybiBbdCwgdl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgc2lkZUVmZmVjdCh2KTtcbiAgICAgICAgICByZXR1cm4gW3QsIHZdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgeyBFcnIsIE9rLCBSZXN1bHQsIFJlcywgS1Jlc3VsdCB9O1xuIl19
